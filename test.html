<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple_chat | Stateless Relay</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary-color: #38bdf8;
            --text-color: #f1f5f9;
            --accent-color: #818cf8;
            --sent-msg: #38bdf8;
            --received-msg: #334155;
            --unread-badge: #ef4444;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            width: 90%;
            max-width: 450px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            margin-top: 0;
        }

        .zone {
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .active {
            display: flex;
        }

        input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            color: white;
            outline: none;
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        #messages {
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .msg {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-break: break-all;
            position: relative;
        }

        .msg.sent {
            align-self: flex-end;
            background: var(--sent-msg);
            color: #0f172a;
            border-bottom-right-radius: 2px;
        }

        .msg.received {
            align-self: flex-start;
            background: var(--received-msg);
            color: white;
            border-bottom-left-radius: 2px;
        }

        .msg-info {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unread-badge {
            background: var(--unread-badge);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 6px;
        }

        .status {
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
        }

        .code-display {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´í„° */
        .unread-counter {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin: 10px 0;
            display: none;
        }

        .unread-counter.active {
            display: block;
        }

        .unread-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .unread-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .unread-item .name {
            font-weight: 600;
            color: var(--text-color);
        }

        .unread-item .count {
            background: var(--unread-badge);
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .read-receipt {
            font-size: 0.7rem;
            color: #10b981;
            text-align: center;
            padding: 4px;
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Simple_chat</h1>

        <!-- ëª¨ë“œ ì„ íƒ -->
        <div id="mode-zone" class="zone active">
            <p class="status">ì ‘ì† ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <button onclick="showZone('master-setup')">ğŸ“± ëª¨ë°”ì¼ (Master)</button>
            <button onclick="showZone('slave-setup')" style="background: #1e293b; border: 1px solid #334155;">ğŸ’» PCì›¹
                (Slave)</button>
        </div>

        <!-- Master ì„¤ì • -->
        <div id="master-setup" class="zone">
            <p class="status">ì²˜ìŒì´ë¼ë©´ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  [ì‹ ê·œ ìƒì„±]ì„,<br>ê¸°ì¡´ ê³„ì •ì´ë¼ë©´ ID ì…ë ¥ í›„ [Salt ì¡°íšŒ]ë¥¼ í•˜ì„¸ìš”.</p>
            <input type="text" id="hwId" placeholder="ê³ ìœ  ID (Username)">
            <input type="password" id="hwSecret" placeholder="Passphrase (Key Derivation ìš©)">
            <div style="display:flex; gap: 8px;">
                <button id="lookupBtn" onclick="lookupSalt()" style="flex:1; background: #1e293b;">ğŸ” Salt ì¡°íšŒ</button>
                <button id="regBtn" onclick="registerMaster(true)" style="flex:1;">âœ¨ ì‹ ê·œ ìƒì„±</button>
            </div>
            <button id="loginBtn" onclick="registerMaster(false)" style="display:none; width:100%; margin-top:8px;">ğŸ”“
                ë¡œê·¸ì¸</button>
            <p id="reg-status" class="status" style="margin-top: 5px;"></p>
        </div>

        <!-- Slave ì„¤ì • -->
        <div id="slave-setup" class="zone">
            <input type="text" id="syncCode" placeholder="ì—°ë™ ì½”ë“œ 6ìë¦¬ ì…ë ¥">
            <button onclick="linkPc()">PC ì—°ë™í•˜ê¸°</button>
        </div>

        <!-- ì±„íŒ…ì°½ -->
        <div id="chat-zone" class="zone">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="status-text" class="status" style="margin:0; text-align: left;"></div>
                <button onclick="copyMyId()"
                    style="padding: 4px 8px; font-size: 0.7rem; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); color: var(--primary-color);">ğŸ“‹
                    ID ë³µì‚¬</button>
            </div>

            <!-- PC ì—°ë™ ì½”ë“œ í‘œì‹œ ì˜ì—­ (ë§ˆìŠ¤í„°ë§Œ) -->
            <div id="sync-area"
                style="display:none; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                <p class="status">PC ì—°ë™ ì½”ë“œ (5ë¶„ í›„ ë§Œë£Œ)</p>
                <div id="display-code" class="code-display">------</div>
            </div>

            <!-- ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´í„° -->
            <div id="unread-counter" class="unread-counter">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">ğŸ“¬ ì½ì§€ ì•Šì€ ë©”ì‹œì§€
                </div>
                <div id="unread-list"></div>
            </div>

            <div id="messages"></div>

            <div
                style="display:flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; margin-top: 10px;">
                <div style="display:flex; gap: 8px;">
                    <input type="text" id="findUsername" style="flex-grow:1; font-size: 0.8rem;"
                        placeholder="ì°¾ì„ Username ì…ë ¥...">
                    <button onclick="findUserByUsername()"
                        style="padding: 8px 12px; font-size: 0.8rem; background: #1e293b;">ğŸ” ì°¾ê¸°</button>
                </div>
                <div style="display:flex; gap: 8px; align-items: center;">
                    <input type="text" id="targetId" style="flex:2;" placeholder="ìƒëŒ€ë°© ê³ ìœ  ID (UUID)">
                    <input type="password" id="chatSecret" style="flex:1; font-size: 0.75rem;"
                        placeholder="ğŸ”‘ Chat Secret (E2EE)">
                </div>
                <p class="status" style="font-size: 0.65rem; margin:0;">* ëŒ€í™” ìƒëŒ€ì™€ ë™ì¼í•œ 'Chat Secret'ì„ ì…ë ¥í•´ì•¼ ë©”ì‹œì§€ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
            <div style="display:flex; gap: 8px;">
                <input type="text" id="chatInput" style="flex-grow:1;" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                <button onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>

        <div style="display:flex; gap: 8px; margin-top: 15px;">
            <button id="codeBtn" onclick="requestCode()"
                style="flex: 1; background: rgba(255,255,255,0.05); color: #94a3b8; font-size: 0.75rem;">PC ì—°ë™ ì½”ë“œ
                ìƒì„±</button>
            <button onclick="refreshUnreadCounts()"
                style="flex: 1; background: rgba(56, 189, 248, 0.1); color: #38bdf8; font-size: 0.75rem; border: 1px solid rgba(56, 189, 248, 0.2);">ğŸ“Š
                ì½ì§€ì•ŠìŒ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="clearLocalData()"
                style="flex: 1; background: rgba(239, 68, 68, 0.1); color: #ef4444; font-size: 0.75rem; border: 1px solid rgba(239, 68, 68, 0.2);">ë°ì´í„°
                ì´ˆê¸°í™”</button>
        </div>
    </div>
    </div>

    <script>
        let socket;
        let myId = ""; // AccountUUID (Server ID)
        let myKey = null; // CryptoKey (Local Only)
        let unreadCounts = {};
        const SERVER_URL = "http://localhost:3000";

        // 1. Initialize IndexedDB (Dexie)
        const db = new Dexie("SimpleChatDB");
        db.version(2).stores({
            messages: "++id, msgId, from, to, timestamp, text, type, status"
        }).upgrade(tx => {
            // Optional: Migrate old version 1 data if needed
            return tx.table("messages").toCollection().modify(m => {
                if (!m.status) m.status = 'delivered';
                if (!m.msgId) m.msgId = 'legacy-' + Math.random().toString(36).substr(2, 9);
            });
        });

        window.onload = () => {
            loadChatHistory();
        };

        // 2. Recovery Logic: Lookup Salt
        function lookupSalt() {
            const username = document.getElementById('hwId').value;
            if (!username) return alert("ID(Username)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            initSocket();
            socket.emit('get_salt', username);

            socket.on('salt_found', (data) => {
                alert("ê¸°ì¡´ ê³„ì •ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. Passphraseë¥¼ ì…ë ¥í•˜ê³  [ë¡œê·¸ì¸] í•˜ì„¸ìš”.");
                window.lastSalt = data.salt;
                window.lastParams = data.kdfParams;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('regBtn').style.display = 'none';
            });

            socket.on('salt_not_found', () => {
                alert("ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. [ì‹ ê·œ ìƒì„±]ì„ ì§„í–‰í•˜ì„¸ìš”.");
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('regBtn').style.display = 'block';
            });
        }

        function initSocket() {
            if (socket) return;
            socket = io(SERVER_URL);

            socket.on('registered', (data) => {
                myId = data.uuid;
                localStorage.setItem('sc_user_uuid', myId);
                showZone('chat-zone');
                document.getElementById('status-text').innerText = `ë‚˜ì˜ ID: ${myId.substring(0, 8)}... (Master)`;
            });

            socket.on('relay_push', async (data) => {
                const decryptedText = await decryptPayload(data.payload);

                // Send ACK immediately back to sender
                socket.emit('msg_ack', { to: data.from, msgId: data.msgId });

                if (decryptedText) {
                    const msg = {
                        msgId: data.msgId,
                        from: data.from,
                        to: data.to,
                        timestamp: data.timestamp,
                        text: decryptedText,
                        type: 'received',
                        status: 'received'
                    };
                    await db.messages.add(msg);
                    addMessageUI(msg.from.substring(0, 8) + '...', msg.text, 'received', msg.msgId);
                } else {
                    addMessageUI(data.from.substring(0, 8) + '...', "[ğŸ”’ ì•”í˜¸í™”ëœ ë©”ì‹œì§€ - Keyê°€ ë§ì§€ ì•ŠìŒ]", 'received', data.msgId);
                }
            });

            socket.on('queue_flush', async (messages) => {
                for (const data of messages) {
                    const decryptedText = await decryptPayload(data.payload);

                    // Send ACK for queued messages too
                    socket.emit('msg_ack', { to: data.from, msgId: data.msgId });

                    if (decryptedText) {
                        const msg = {
                            msgId: data.msgId,
                            from: data.from,
                            to: data.to,
                            timestamp: data.timestamp,
                            text: decryptedText,
                            type: 'received',
                            status: 'received'
                        };
                        await db.messages.add(msg);
                        addMessageUI(msg.from.substring(0, 8) + '...', msg.text, 'received', msg.msgId);
                    } else {
                        addMessageUI(data.from.substring(0, 8) + '...', "[ğŸ”’ ì•”í˜¸í™”ëœ ë©”ì‹œì§€ (Queue)]", 'received', data.msgId);
                    }
                }
            });

            // Handle incoming ACKs for messages WE sent
            socket.on('msg_ack_push', async (data) => {
                console.log(`âœ… [ACK] Received for ${data.msgId}`);
                await db.messages.where('msgId').equals(data.msgId).modify({ status: 'delivered' });

                // Update UI status badge
                const statusEl = document.getElementById(`status-${data.msgId}`);
                if (statusEl) {
                    statusEl.innerText = "âœ“ ì½ìŒ(ë„ë‹¬)";
                    statusEl.style.color = "#10b981";
                }
            });

            socket.on('dispatch_status', async (data) => {
                console.log(`ğŸ“¡ [Dispatch] ${data.status} for ${data.msgId}`);
                if (data.status === 'queued') {
                    const statusEl = document.getElementById(`status-${data.msgId}`);
                    if (statusEl) statusEl.innerText = "â³ ëŒ€ê¸°ì¤‘(ì˜¤í”„ë¼ì¸)";
                }
            });

            socket.on('error_msg', (data) => alert(data.message));
        }

        // 3. Key Hierarchy & Argon2
        async function registerMaster(isNew = true) {
            const username = document.getElementById('hwId').value;
            const secret = document.getElementById('hwSecret').value;
            if (!username || !secret) return alert("IDì™€ Passphraseë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const salt = isNew ? crypto.randomUUID() : window.lastSalt;
            const params = isNew ? { time: 2, mem: 16384, hashLen: 64 } : window.lastParams;

            const status = document.getElementById('reg-status');
            status.innerText = "â³ Key Generating (Argon2)...";

            try {
                const result = await argon2.hash({
                    pass: secret,
                    salt: salt,
                    time: params.time,
                    mem: params.mem,
                    hashLen: params.hashLen,
                    type: argon2.ArgonType.Argon2id
                });

                // Split 64-byte hash: [32-byte UUID] [32-byte Encryption Key]
                const hashBytes = result.hash;
                const uuidPart = hashBytes.slice(0, 32);
                const keyPart = hashBytes.slice(32, 64);

                myId = Array.from(uuidPart).map(b => b.toString(16).padStart(2, '0')).join('');

                // Import Key for WebCrypto
                myKey = await crypto.subtle.importKey(
                    "raw", keyPart, "AES-GCM", false, ["encrypt", "decrypt"]
                );

                // Save Key to Session (Memory only for security)
                window.sessionKey = myKey;

                initSocket();
                socket.emit('register_master', {
                    uuid: myId,
                    username: isNew ? username : undefined,
                    salt: salt,
                    kdfParams: params
                });
            } catch (e) {
                console.error(e);
                status.innerText = "âŒ ì‹¤íŒ¨";
            }
        }

        // Helper: Get Encryption Key (Chat Secret or Session Key)
        async function getActiveKey() {
            const chatSecret = document.getElementById('chatSecret').value;
            if (chatSecret) {
                // Generate a temporary key from the Chat Secret
                const encoder = new TextEncoder();
                const keyData = await crypto.subtle.digest("SHA-256", encoder.encode(chatSecret));
                return await crypto.subtle.importKey(
                    "raw", keyData, "AES-GCM", false, ["encrypt", "decrypt"]
                );
            }
            return window.sessionKey;
        }

        // 4. Encryption & Binary Serialization
        async function encryptPayload(text) {
            const encryptionKey = await getActiveKey();
            if (!encryptionKey) return null;

            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const iv = crypto.getRandomValues(new Uint8Array(12));

            const ciphertext = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                encryptionKey,
                data
            );

            const packet = new Uint8Array(1 + 12 + ciphertext.byteLength);
            packet[0] = 0x01; // Version 1
            packet.set(iv, 1);
            packet.set(new Uint8Array(ciphertext), 13);
            return packet;
        }

        async function decryptPayload(data) {
            const decryptionKey = await getActiveKey();
            if (!decryptionKey) return null;

            try {
                const packet = new Uint8Array(data);
                const version = packet[0];
                const iv = packet.slice(1, 13);
                const ciphertext = packet.slice(13);

                const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    decryptionKey,
                    ciphertext
                );
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.warn("Decryption failed - possibly wrong key", e);
                return null; // Return null to show fallback or error
            }
        }

        async function sendMessage() {
            const targetId = document.getElementById('targetId').value;
            const text = document.getElementById('chatInput').value;
            if (!text || !targetId) return;

            const msgId = crypto.randomUUID();
            const binaryPayload = await encryptPayload(text);
            socket.emit('relay', {
                msgId: msgId,
                to: targetId,
                payload: binaryPayload
            });

            const msg = {
                msgId: msgId,
                from: myId,
                to: targetId,
                timestamp: Date.now(),
                text,
                type: 'sent',
                status: 'pending'
            };
            await db.messages.add(msg);
            addMessageUI('ë‚˜', text, 'sent', msgId);
            document.getElementById('chatInput').value = '';
        }

        function addMessageUI(sender, text, type, msgId = null) {
            const msgArea = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg ${type}`;

            let statusBadge = "";
            if (type === 'sent' && msgId) {
                statusBadge = `<span id="status-${msgId}" style="font-size: 0.6rem; margin-left:8px; color: #94a3b8;">â³ ì „ì†¡ì¤‘</span>`;
            }

            div.innerHTML = `
                <div class="msg-info">
                    <span>${sender}</span>
                    ${statusBadge}
                </div>
                <div>${text}</div>
            `;
            msgArea.appendChild(div);
            msgArea.scrollTop = msgArea.scrollHeight;
        }

        async function loadChatHistory() {
            const history = await db.messages.orderBy('timestamp').limit(100).toArray();
            history.forEach(msg => {
                const sender = msg.from === myId ? 'ë‚˜' : msg.from.substring(0, 8) + '...';
                const div = addMessageUI(sender, msg.text, msg.type, msg.msgId);

                // Update status badge if it's already delivered
                if (msg.type === 'sent' && msg.status === 'delivered') {
                    const statusEl = document.getElementById(`status-${msg.msgId}`);
                    if (statusEl) {
                        statusEl.innerText = "âœ“ ì½ìŒ(ë„ë‹¬)";
                        statusEl.style.color = "#10b981";
                    }
                }
            });
        }

        function showZone(id) {
            document.querySelectorAll('.zone').forEach(z => z.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function clearLocalData() {
            if (confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°(ID, ì±„íŒ… ë‚´ì—­)ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
                db.delete().then(() => {
                    localStorage.clear();
                    location.reload();
                });
            }
        }

        function findUserByUsername() {
            const username = document.getElementById('findUsername').value;
            if (!username) return;
            initSocket();
            socket.emit('get_salt', username);

            // Temporary one-time listener for discovery
            socket.once('salt_found', (data) => {
                document.getElementById('targetId').value = data.uuid;
                alert(`ìœ ì €ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤: ${username}\nIDê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
            socket.once('salt_not_found', () => alert("í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }

        function copyMyId() {
            if (!myId) return;
            navigator.clipboard.writeText(myId);
            alert("ë‚˜ì˜ ê³ ìœ  ID(UUID)ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function refreshUnreadCounts() {
            // Unread counts are handled locally or via server later
            console.log("Refresh unread counts - logic to be updated");
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>

</body>

</html>